<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">

    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
    <meta http-equiv="Content-Security-Policy" content="default-src * data:; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">

    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache">

    <script src="components/loader.js"></script>
    <script src="p5.js"></script>
    <style> body {padding: 0; margin: 0} </style> <!-- this line removes any default padding -->
    <script type="text/javascript" charset="utf-8" src="components/loader.js"></script>
    <script type="text/javascript" charset="utf-8" src="components/monaca-jquery/jquery.js"></script>
</head>
<body>

<script>

var debug = 0;// 1:debug

var startMs = 0;
var direction = 0;
var num = 5;
var numMax = 9;

var imgSize = 200;

var edgeWidth = 100;
var edgeHeight = 100;

var buttons = [];

var mode = 0;// 0:hanger, 1:tile

var img;
function preload(){
    var v = Math.random().toString(36).slice(-8);// 画像のキャッシュ防止
    img = [];
    for(var i=1;i<numMax+1;i++){
        if( window.location.href.match(/preview/) ){ // monacaでのプレビュー用
            img[i] = loadImage('default/'+String(i)+'.jpg');
        }else if( window.location.href.match(/localhost/) ){ // localでの動作確認用
            img[i] = loadImage('../default/'+String(i)+'.jpg');
        }else{
            img[i] = loadImage('https://barcelona.sakura.ne.jp/sandbox/hanger2/'+String(i)+'.jpg?'+v);
        }
    }
    img["hanger"] = loadImage('hanger.png');
}

function setup(){

    var s = window.location.search;
    if( s == "" ){
        num = 1;
    }else{
        s = s.substring(1); // index.html?1から1を抽出する
        num = parseInt(s);
    }

    bg_width = windowWidth;
    bg_height = windowHeight;
    createCanvas(bg_width,bg_height);

    setButtons();

    drawHanger( 0, num );

}

function Button(x,y){
    this.x = x;
    this.y = y;
}

function setButtons(){
    buttons["reload"] = new Button(windowWidth/4, 20);
    buttons["all"] = new Button(windowWidth*3/4,20);
    buttons["+1"] = new Button(windowWidth-20, windowHeight/2);
    buttons["-1"] = new Button(20,windowHeight/2);
    buttons["camera"] = new Button(windowWidth/4,windowHeight-10);
    buttons["library"] = new Button(windowWidth*3/4,windowHeight-10);

    var tileSize = windowWidth/3;
    var x1 = windowWidth/2 - tileSize;
    var x2 = windowWidth/2;
    var x3 = windowWidth/2 + tileSize;
    var y1 = windowHeight/2 - tileSize;
    var y2 = windowHeight/2;
    var y3 = windowHeight/2 + tileSize;
    buttons[1] = new Button(x1,y1);
    buttons[2] = new Button(x2,y1);
    buttons[3] = new Button(x3,y1);
    buttons[4] = new Button(x1,y2);
    buttons[5] = new Button(x2,y2);
    buttons[6] = new Button(x3,y2);
    buttons[7] = new Button(x1,y3);
    buttons[8] = new Button(x2,y3);
    buttons[9] = new Button(x3,y3);
}

function drawButtons(){
    drawButton("reload");
    drawButton("all");
    drawButton("+1");
    drawButton("-1");
    drawButton("camera");
    drawButton("library");
}

function drawButton(str){
    noStroke();
    fill("black");
    textAlign(CENTER);
    textSize("14");
    text(str,buttons[str].x,buttons[str].y);
}

function touchEnded(){

    var X = touchX;
    var Y = touchY

    if( checkClick("+1",X,Y) ){
        direction = -1;
        if( num == numMax ){
            num = 1;
        }else{
            num = num + 1;
        }
        startMs = millis();
    }

    if( checkClick("-1",X,Y) ){
        direction = +1;
        if( num == 1 ){
            num = numMax;
        }else{
            num = num - 1;
        }
        startMs = millis();
    }

    if( checkClick("camera",X,Y) ){
        getCamera();
    }

    if( checkClick("library",X,Y) ){
        getLibrary();
    }

    if( checkClick("reload",X,Y) ){
        location.href = 'index.html?'+num;
    }

    if( checkClick("all",X,Y) ){
        mode = 1;
        showTile();
    }

    if( mode == 1 ){ // show as tile
        for(var i=1;i<numMax+1;i++){
            if( checkClick(i,X,Y) ){
                location.href = "index.html?"+i;
            }
        }
    }

}

function checkClick(str,X,Y){
    var area = 100;
    var x = buttons[str].x;
    var y = buttons[str].y;
    if( x-area < X && X < x+area ){
        if( y-area < Y && Y < y+area ){
            return 1;
        }
    }
    return 0;
}

function showTile(){

    clear();

    var tileSize = windowWidth/3;
    var x1 = windowWidth/2 - tileSize;
    var x2 = windowWidth/2;
    var x3 = windowWidth/2 + tileSize;
    var y1 = windowHeight/2 - tileSize;
    var y2 = windowHeight/2;
    var y3 = windowHeight/2 + tileSize;

    image(img[1],x1,y1,tileSize,tileSize);
    image(img[2],x2,y1,tileSize,tileSize);
    image(img[3],x3,y1,tileSize,tileSize);
    image(img[4],x1,y2,tileSize,tileSize);
    image(img[5],x2,y2,tileSize,tileSize);
    image(img[6],x3,y2,tileSize,tileSize);
    image(img[7],x1,y3,tileSize,tileSize);
    image(img[8],x2,y3,tileSize,tileSize);
    image(img[9],x3,y3,tileSize,tileSize);

    drawButtons();

}

function drawHanger(x,num){

    if( num == 0 ){
        num = numMax;
    }

    if( num == numMax+1 ){
        num = 1;
    }

    var hangerWidth = 500/2;
    var hangerHeight = 300/2;
    var x1 = windowWidth/2 + x;
    var y1 = hangerHeight/2 + 20;// ハンガー上部が時刻表示にかからない程度
    var y2 = hangerHeight/2 + 65;// ハンガー中央におさまるように番号を表示
    var y3 = hangerHeight/2 + imgSize;// 画像下部のテキスト位置

    imageMode(CENTER);
    image(img["hanger"],x1,y1,hangerWidth,hangerHeight);

    stroke("black");
    noFill();
    textSize(40);
    textAlign(CENTER);
    text(num,x1,y2);

    imageMode(CENTER);
    image(img[num],x1,windowHeight/2,imgSize,imgSize);

}

function draw(){

    var interval = 300;
    var ms = millis();
    var d1 = interval - (ms - startMs);
    var d2 = ms - startMs;

    drawButtons();

    if( ms - startMs < interval ){
        clear();

        // 次に表示するハンガー
        drawHanger( d1 * direction ,num );
        // 元々、表示していたハンガー
        drawHanger( d2 * direction * (-1) , num + direction  );
    }

}

function getCamera(){
    navigator.camera.getPicture(
        onSuccess,
        onFail,
        {
            destinationType: Camera.DestinationType.FILE_URI,
            allowEdit:true
        });
}

function getLibrary(){
    navigator.camera.getPicture(
        onSuccess,
        onFail,
        {
            destinationType: Camera.DestinationType.FILE_URI,
            sourceType: Camera.PictureSourceType.PHOTOLIBRARY
        });
}

function onSuccess(data){
    var img = new Image();
    img.src = data;

    $(img).bind("load",function(){
        $("div#image-box").html($(img));

        var canvas = document.getElementById("c1");
        if( canvas.getContext ){
            var context = canvas.getContext('2d');
            context.drawImage(img,0,0,imgSize,imgSize);
            var data = canvas.toDataURL('image/jpeg');
            postImage(data);
        }
    });
}

function onFail(){
    alert("onFail");
}

function postImage(image){
    alert(num);
    $.post(
        "http://barcelona.sakura.ne.jp/sandbox/hanger2/recvImage.php?fname="+num+".jpg",
        {
            'image':image
        },
        function(data){
            alert("success");
        },
        function(data){
            alert("failed");
        }
    );
}


</script>
<canvas hidden id="c1" width="200" height="200"></canvas>
</body>
</html>